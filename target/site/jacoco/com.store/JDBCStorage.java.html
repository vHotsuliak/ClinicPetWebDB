<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="uk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JDBCStorage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ClinicPetWebJDBC Maven Webapp</a> &gt; <a href="index.source.html" class="el_package">com.store</a> &gt; <span class="el_source">JDBCStorage.java</span></div><h1>JDBCStorage.java</h1><pre class="source lang-java linenums">package com.store;

import com.models.Client;
import com.service.Settings;

import java.sql.*;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;

import static com.models.CreatePet.createPet;

public class JDBCStorage implements Storage {
    private final Connection connection;

    //last id're for clients and pets
<span class="fc" id="L18">    private final AtomicInteger idsClint = new AtomicInteger();</span>

    public AtomicInteger getIdsClint() {
<span class="nc" id="L21">        return idsClint;</span>
    }

<span class="fc" id="L24">    private final AtomicInteger idsPet = new AtomicInteger();</span>

    // -----SQL commands-----

    //Insert
<span class="fc" id="L29">    private final String INSERT_CLIENT                  = &quot;INSERT into Clients VALUES ( ?, ?)&quot;;</span>
<span class="fc" id="L30">    private final String INSERT_PET                     = &quot;INSERT into Pets VALUES ( ?, ?, ?, ?)&quot;;</span>

    // Delete
<span class="fc" id="L33">    private final String DELETE_PET                     = &quot;Delete From Pets where client_id = ?&quot;;</span>
<span class="fc" id="L34">    private final String DELETE_CLIENT                  = &quot;Delete From Clients where user_id = ?&quot;;</span>

    // Update
<span class="fc" id="L37">    private final String UPDATE_CLIENT                  = &quot;UPDATE Clients SET user_nic = ? Where user_id = ?&quot;;</span>
<span class="fc" id="L38">    private final String UPDATE_PET                     = &quot;UPDATE Pets SET nic = ?, kind_of_pet = ? Where client_id = ?&quot;;</span>

    // Search
    // SQL search request by one parameter
<span class="fc" id="L42">    private final String SEARCH_CLIENT_BY_PET_NAME                = &quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id And Pets.nic = ?&quot;;</span>
<span class="fc" id="L43">    private final String SEARCH_CLIENT_BY_KIND_OF_PET             = &quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id And Pets.kind_of_pet = ?&quot;;</span>
<span class="fc" id="L44">    private final String SEARCH_CLIENT_BY_CLIENT_NAME             = &quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id And Client.user_nic = ?&quot;;</span>
    // SQL request by two parameters
<span class="fc" id="L46">    private final String SEARCH_CLIENT_BY_PET                     = &quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id And Pets.nic = ? And Pets.kind_of_pet = ?&quot;;</span>
<span class="fc" id="L47">    private final String SEARCH_CLIENT_BY_PET_AND_CLIENT_NAME     = &quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id And Client.user_nic = ? And Pets.nic = ?&quot;;</span>
<span class="fc" id="L48">    private final String SEARCH_CLIENT_BY_KIND_OF_PET_AND_CLIENT  = &quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id And Client.user_nic = ?  And Pets.kind_of_pet = ?&quot;;</span>
    // SQL request by three parameters
<span class="fc" id="L50">    private final String SEARCH_CLIENT_BY_PET_AND_CLIENT          = &quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id And Client.user_nic = ? And Pets.nic = ? And Pets.kind_of_pet = ?&quot;;</span>

    // -----SQL commands-----

<span class="fc" id="L54">    public JDBCStorage() {</span>
<span class="fc" id="L55">        final Settings settings = Settings.getInstance();</span>

        // Didn't work without it and must be before connection
        try {
<span class="fc" id="L59">            Class.forName(settings.value(&quot;jdbc.driver_class&quot;));</span>
<span class="nc" id="L60">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L61">            e.printStackTrace();</span>
<span class="fc" id="L62">        }</span>

        try {
<span class="fc" id="L65">            this.connection = DriverManager.getConnection(settings.value(&quot;jdbc.url&quot;),</span>
<span class="fc" id="L66">                    settings.value(&quot;jdbc.username&quot;), settings.value(&quot;jdbc.password&quot;));</span>
<span class="nc" id="L67">        }catch (SQLException e) {</span>
<span class="nc" id="L68">            throw new IllegalStateException(e);</span>
<span class="fc" id="L69">        }</span>

<span class="fc" id="L71">        try(final Statement statement = this.connection.createStatement();</span>
<span class="fc" id="L72">            final ResultSet rsClient = statement.executeQuery(&quot;SELECT MAX(user_id) as max FROM Clients WHERE user_id is not null&quot;)) {</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">                while (rsClient.next())</span>
<span class="fc" id="L74">                    idsClint.set(rsClient.getInt(&quot;max&quot;));</span>
<span class="nc" id="L75">        } catch (SQLException e) {</span>
<span class="nc" id="L76">            e.printStackTrace();</span>
<span class="fc" id="L77">        }</span>

<span class="fc" id="L79">        try(final Statement statement = this.connection.createStatement();</span>
<span class="fc" id="L80">            final ResultSet rsPet = statement.executeQuery(&quot;SELECT MAX(pet_id) as max FROM Pets WHERE pet_id is not null&quot;)) {</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                while (rsPet.next())</span>
<span class="fc" id="L82">                    idsPet.set(rsPet.getInt(&quot;max&quot;));</span>
<span class="nc" id="L83">        } catch (SQLException e) {</span>
<span class="nc" id="L84">            e.printStackTrace();</span>
<span class="fc" id="L85">        }</span>

<span class="fc" id="L87">    }</span>

    @Override
    public Collection&lt;Client&gt; values() {
<span class="fc" id="L91">        final List&lt;Client&gt; clients = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L92">        try(final Statement statement = this.connection.createStatement();</span>
<span class="fc" id="L93">            final ResultSet rs = statement.executeQuery(&quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id&quot;)) {</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">            while (rs.next())</span>
<span class="fc" id="L95">                clients.add(new Client(rs.getInt(&quot;user_id&quot;), rs.getString(&quot;user_nic&quot;), createPet(rs.getString(&quot;kind_of_pet&quot;), rs.getString(&quot;nic&quot;))));</span>
<span class="nc" id="L96">        } catch (SQLException e) {</span>
<span class="nc" id="L97">            e.printStackTrace();</span>
<span class="fc" id="L98">        }</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">        if (clients.size() == 0)</span>
<span class="nc" id="L100">            idsClint.set(0);</span>
<span class="fc" id="L101">        return clients;</span>
    }

    @Override
    public void add(Client client) {
<span class="fc" id="L106">        addPet(new Client(createID(client), client.getClientName(),</span>
<span class="fc" id="L107">                createPet(client.getKindOfPet(), client.getPetName())));</span>
<span class="fc" id="L108">    }</span>

    private int createID(Client client) {
<span class="fc" id="L111">        try(final PreparedStatement statement = this.connection.prepareStatement(INSERT_CLIENT)) {</span>
<span class="fc" id="L112">            AtomicInteger ids = new AtomicInteger(idsClint.incrementAndGet());</span>
<span class="fc" id="L113">            statement.setInt(1, ids.get());</span>
<span class="fc" id="L114">            statement.setString(2, client.getClientName());</span>
<span class="fc" id="L115">            statement.executeUpdate();</span>
<span class="fc" id="L116">            return ids.get();</span>
<span class="nc" id="L117">        } catch (SQLException e) {</span>
<span class="nc" id="L118">            e.printStackTrace();</span>
        }

<span class="nc" id="L121">        throw new IllegalStateException(&quot;Could not create new user&quot;);</span>
    }

    private void addPet(Client client) {
<span class="fc" id="L125">        try(final PreparedStatement statement = this.connection.prepareStatement(INSERT_PET)) {</span>
<span class="fc" id="L126">            AtomicInteger ids = new AtomicInteger(idsPet.incrementAndGet());</span>
<span class="fc" id="L127">            statement.setInt(1, ids.get());</span>
<span class="fc" id="L128">            statement.setInt(2, client.getId());</span>
<span class="fc" id="L129">            statement.setString(3, client.getPetName());</span>
<span class="fc" id="L130">            statement.setString(4, client.getKindOfPet());</span>
<span class="fc" id="L131">            statement.executeUpdate();</span>
<span class="fc" id="L132">            return;</span>
<span class="nc" id="L133">        } catch (SQLException e) {</span>
<span class="nc" id="L134">            e.printStackTrace();</span>
        }

<span class="nc" id="L137">        throw new IllegalStateException(&quot;Could not create new pet&quot;);</span>
    }

    @Override
    public void edit(Client client) {
<span class="fc" id="L142">        try(final PreparedStatement statement = this.connection.prepareStatement(UPDATE_CLIENT)) {</span>
<span class="fc" id="L143">            statement.setString(1, client.getClientName());</span>
<span class="fc" id="L144">            statement.setInt(2, client.getId());</span>
<span class="fc" id="L145">            statement.executeUpdate();</span>
<span class="nc" id="L146">        } catch (SQLException e) {</span>
<span class="nc" id="L147">            e.printStackTrace();</span>
<span class="fc" id="L148">        }</span>

<span class="fc" id="L150">        try(final PreparedStatement statement = this.connection.prepareStatement(UPDATE_PET)) {</span>
<span class="fc" id="L151">            statement.setString(1, client.getPetName());</span>
<span class="fc" id="L152">            statement.setString(2, client.getKindOfPet());</span>
<span class="fc" id="L153">            statement.setInt(3, client.getId());</span>
<span class="fc" id="L154">            statement.executeUpdate();</span>
<span class="nc" id="L155">        } catch (SQLException e) {</span>
<span class="nc" id="L156">            e.printStackTrace();</span>
<span class="fc" id="L157">        }</span>
<span class="fc" id="L158">    }</span>

    @Override
    public void delete(int id) {
<span class="fc" id="L162">        deletePet(id);</span>
<span class="fc" id="L163">        deleteClient(id);</span>
<span class="fc" id="L164">    }</span>

    private void deleteClient(int id) {
<span class="fc" id="L167">        try(final PreparedStatement statement = this.connection.prepareStatement(DELETE_CLIENT)) {</span>
<span class="fc" id="L168">            statement.setInt(1, id);</span>
<span class="fc" id="L169">            statement.executeUpdate();</span>
<span class="fc" id="L170">            return;</span>
<span class="nc" id="L171">        } catch (SQLException e) {</span>
<span class="nc" id="L172">            e.printStackTrace();</span>
        }

<span class="nc" id="L175">        throw new IllegalStateException(&quot;Could not delete client&quot;);</span>
    }

    private void deletePet(int id) {
<span class="fc" id="L179">        try(final PreparedStatement statement = this.connection.prepareStatement(DELETE_PET)) {</span>
<span class="fc" id="L180">            statement.setInt(1, id);</span>
<span class="fc" id="L181">            statement.executeUpdate();</span>
<span class="fc" id="L182">            return;</span>
<span class="nc" id="L183">        } catch (SQLException e) {</span>
<span class="nc" id="L184">            e.printStackTrace();</span>
        }

<span class="nc" id="L187">        throw new IllegalStateException(&quot;Could not delete pet&quot;);</span>
    }

    @Override
    public Client get(int id) {
<span class="fc" id="L192">        Client client = null;</span>
<span class="fc" id="L193">        try (final PreparedStatement statement = this.connection.prepareStatement(&quot;SELECT * FROM Clients JOIN Pets ON Clients.user_id=Pets.client_id AND Clients.user_id = ?&quot;)) {</span>
<span class="fc" id="L194">            statement.setInt(1, id);</span>
<span class="fc" id="L195">            try(final ResultSet rs = statement.executeQuery()){</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">                while (rs.next())</span>
<span class="fc" id="L197">                client = new Client(rs.getInt(&quot;user_id&quot;), rs.getString(&quot;user_nic&quot;), createPet(rs.getString(&quot;kind_of_pet&quot;), rs.getString(&quot;nic&quot;)));</span>
            }
<span class="nc" id="L199">        } catch (SQLException e) {</span>
<span class="nc" id="L200">            e.printStackTrace();</span>
        } finally {
<span class="pc" id="L202">            return client;</span>
        }
    }

    @Override
    public Collection&lt;Client&gt; searchClient(final String clientName, final String petName, final String kindOfPet) {
<span class="nc" id="L208">        List&lt;Client&gt; clients = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L210" title="All 6 branches missed.">        if (!clientName.isEmpty() &amp;&amp; petName.isEmpty() &amp;&amp; kindOfPet.isEmpty())</span>
<span class="nc" id="L211">            clients = oneCondition(clientName, SEARCH_CLIENT_BY_CLIENT_NAME); // Where Client.user_nic = ?&quot;</span>
<span class="nc bnc" id="L212" title="All 6 branches missed.">        else if (clientName.isEmpty() &amp;&amp; !petName.isEmpty() &amp;&amp; kindOfPet.isEmpty())</span>
<span class="nc" id="L213">            clients = oneCondition(petName, SEARCH_CLIENT_BY_PET_NAME); // Where Pets.nic = ?</span>
<span class="nc bnc" id="L214" title="All 6 branches missed.">        else if (clientName == null &amp;&amp; petName == null &amp;&amp; !kindOfPet.isEmpty())</span>
<span class="nc" id="L215">            clients = oneCondition(kindOfPet, SEARCH_CLIENT_BY_KIND_OF_PET); // Where Pets.kind_of_pet = ?</span>
<span class="nc bnc" id="L216" title="All 6 branches missed.">        else if (!clientName.isEmpty() &amp;&amp; !petName.isEmpty() &amp;&amp; kindOfPet.isEmpty())</span>
<span class="nc" id="L217">            clients = twoCondition(clientName, petName, SEARCH_CLIENT_BY_PET_AND_CLIENT_NAME); // Where Pets.nic = ? And Client.user_nic = ?&quot;</span>
<span class="nc bnc" id="L218" title="All 6 branches missed.">        else if (clientName.isEmpty() &amp;&amp; !petName.isEmpty() &amp;&amp; !kindOfPet.isEmpty())</span>
<span class="nc" id="L219">            clients = twoCondition(clientName, petName, SEARCH_CLIENT_BY_PET); // Where Pets.nic = ? And Pets.kind_of_pet = ?</span>
<span class="nc bnc" id="L220" title="All 6 branches missed.">        else if (!clientName.isEmpty() &amp;&amp; petName.isEmpty() &amp;&amp; !kindOfPet.isEmpty())</span>
<span class="nc" id="L221">            clients = twoCondition(clientName, kindOfPet, SEARCH_CLIENT_BY_KIND_OF_PET_AND_CLIENT); // Where Client.user_nic = ?  And Pets.kind_of_pet = ?</span>
<span class="nc bnc" id="L222" title="All 6 branches missed.">        else if (!clientName.isEmpty() &amp;&amp; petName.isEmpty() &amp;&amp; !kindOfPet.isEmpty())</span>
<span class="nc" id="L223">            clients = threeCondition(clientName, petName, kindOfPet, SEARCH_CLIENT_BY_PET_AND_CLIENT); // Where Client.user_nic = ?  And Pets.kind_of_pet = ?</span>
<span class="nc" id="L224">        return clients;</span>
    }

    private List&lt;Client&gt; threeCondition(String condition1, String condition2, String condition3, String SQLSearchRequest) {
<span class="nc" id="L228">        return null;</span>
    }



    private List&lt;Client&gt; oneCondition(final String condition1, final String SQLSqarchRequest) {
<span class="nc" id="L234">        final List&lt;Client&gt; clients = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L235">        try(final PreparedStatement statement = this.connection.prepareStatement(SQLSqarchRequest)) {</span>
<span class="nc" id="L236">            statement.setString(1, condition1);</span>
<span class="nc" id="L237">            try (final ResultSet rs = statement.executeQuery()) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                while (rs.next())</span>
<span class="nc" id="L239">                    clients.add(new Client(rs.getInt(&quot;user_id&quot;), rs.getString(&quot;user_nic&quot;), createPet(rs.getString(&quot;kind_of_pet&quot;), rs.getString(&quot;nic&quot;))));</span>
            }
<span class="nc" id="L241">        } catch (SQLException e) {</span>
<span class="nc" id="L242">            e.printStackTrace();</span>
<span class="nc" id="L243">        }</span>
<span class="nc" id="L244">        return clients;</span>
    }

    private List&lt;Client&gt; twoCondition(String condition1, String condition2, String SQLSearchRequest) {
<span class="nc" id="L248">        return null;</span>
    }

<span class="fc" id="L251">    public int getLastId(){return this.idsClint.get();}</span>

    @Override
    public void close() {
        try {
<span class="nc" id="L256">            connection.close();</span>
<span class="nc" id="L257">        } catch (SQLException e) {</span>
<span class="nc" id="L258">            e.printStackTrace();</span>
<span class="nc" id="L259">        }</span>
<span class="nc" id="L260">    }</span>

    /*
    private List&lt;Client&gt; oneCondition(String clientName, String petName, String kindOfPet) {
        final String condition = condition(clientName, petName, kindOfPet, 1);

    }*/

    /*
     * Return i-th not null string parameter, if there aren't i-th parameter then null. Available 'i' is 1st or 2nd!!!
     * @param clientName contains client name.
     * @param petName contains pet name.
     * @param kindOfPet contains kind of pet.
     * @param i how mach parameters, at list, should be not null.
     * @return i-th not zero string parameter. If there aren't i-th parameter then null.
     *
    private String condition(String clientName, String petName, String kindOfPet, int i) {
        int counter = 1;

        if (clientName != null)
            if (i == counter)
                return clientName;
            else
                counter++;
        if (petName != null)
            if (i == counter)
                return petName;
            else
                counter++;
        if (kindOfPet != null)
            if (i == counter)
                return kindOfPet;
            else
                counter++;

        return null;
    }*/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>